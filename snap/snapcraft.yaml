name: tauno-serial-plotter
base: core24
grade: stable
confinement: strict
version: '1.20.4'
summary: Simple serial plotter
description: |
  Tauno Serial Plotter is simple serial plotter for Arduino and others.

  If no ports show up. Then:

  `sudo usermod -a -G dialout $USER`

  `sudo snap connect tauno-serial-plotter:raw-usb`
compression: lzo

platforms:
  amd64:
  arm64:

slots:
  qt6-content:
    interface: content
    content: qt6
    default-provider: qt6-core24
    target: $SNAP/qt6

parts:
  tauno-serial-plotter:
    source: .
    plugin: python
    python-requirements: ['requirements.txt']
    stage-packages:
      - python3-pyqt6
      - qtwayland6
    override-build: |
      craftctl default
      # Ensure the script is in the bin folder and executable
      mkdir -p $CRAFT_PART_INSTALL/bin
      cp -av src/tauno-serial-plotter.py $CRAFT_PART_INSTALL/bin/
      chmod +x $CRAFT_PART_INSTALL/bin/tauno-serial-plotter.py
    icons:
      plugin: dump
      source: src/icons/
      organize:
        'tauno-plotter.svg': usr/share/icons/hicolor/scalable/apps/tauno-plotter.svg


  # copy icons to snap
  desktop-gui:
    plugin: dump
    source: src/icons/
    organize:
      '*.svg' : bin/icons/
    stage:
      - bin/icons/


# https://github.com/snapcrafters/arduino/blob/master/snapcraft.yaml
apps:
  tauno-serial-plotter:
    extensions: [ gnome ] # Provides the runtime environment
    #command: bin/desktop-launch tauno-serial-plotter.py
    command: usr/bin/desktop-launch6 tauno-serial-plotter.py
      command-chain:
        - bin/snap-command-wrapper
    #environment:
      # Fallback to XWayland if running in a Wayland session.
      #DISABLE_WAYLAND: 1
    plugs:
    #- unity7
    - home
    - removable-media
    - network
    - serial-port
    - raw-usb
    - desktop
    - desktop-legacy
    - x11
    - wayland
    - opengl
    - network-bind
    - hardware-observe

#desktop-wrapper:
#  plugin: nil
#  override-build: |
#    mkdir -p $SNAPCRAFT_PART_INSTALL/bin
#    cat <<EOF > $SNAPCRAFT_PART_INSTALL/bin/snap-command-wrapper
#    #!/bin/sh
#    export XDG_DATA_DIRS=\$SNAP/qt6/usr/share:\$XDG_DATA_DIRS
#    export QT_PLUGIN_PATH=\$SNAP/qt6/usr/lib/\$CRAFT_ARCH_TRIPLET/qt6/plugins
#    export QML2_IMPORT_PATH=\$SNAP/qt6/usr/lib/\$CRAFT_ARCH_TRIPLET/qt6/qml
#    export QTCHOICE_PLATFORM_PLUGIN_PATH=\$SNAP/qt6/usr/lib/\$CRAFT_ARCH_TRIPLET/qt6/plugins/platforms
#    exec "\$@"
#    EOF
#    chmod +x $SNAPCRAFT_PART_INSTALL/bin/snap-command-wrapper